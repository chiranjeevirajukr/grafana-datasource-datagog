{"version":3,"sources":["../../src/query_ctrl.js"],"names":["queryBuilder","DataDogQueryCtrl","$scope","$injector","$q","uiSegmentSrv","templateSrv","removeText","target","aggregation","aggregationSegment","newSegment","value","fake","custom","metric","metricSegment","tags","tagSegments","map","fixTagSegments","functions","f","createFuncInstance","func","funcDef","withDefaultParams","params","slice","as","asSegment","rawQuery","datasource","metricFindQuery","then","transformToSegments","when","text","segment","metricFindTags","type","removeSegment","results","unshift","panelCtrl","refresh","count","length","lastSegment","Math","max","push","newPlusButton","error","def","name","without","persistFunctions","targetChanged","added","index","splice","realSegments","filter","addTemplateVars","segments","expandable","variables","variable","query","buildQuery","templateUrl"],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AACA;;AACA;;AACA;;AACA;;IAAYA,Y;;;;;;;;;;;;IAECC,gB,WAAAA,gB;;;AAEX,4BAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,EAA/B,EAAmCC,YAAnC,EAAiDC,WAAjD,EAA+D;AAAA;;AAAA,oIACvDJ,MADuD,EAC/CC,SAD+C;;AAE7D,UAAKI,UAAL,GAAkB,kBAAlB;AACA,UAAKH,EAAL,GAAUA,EAAV;AACA,UAAKC,YAAL,GAAoBA,YAApB;AACA,UAAKC,WAAL,GAAmBA,WAAnB;;AAEA,QAAI,MAAKE,MAAL,CAAYC,WAAhB,EAA6B;AAC3B,YAAKC,kBAAL,GAA0B,IAAIL,aAAaM,UAAjB,CACxB,MAAKH,MAAL,CAAYC,WADY,CAA1B;AAGD,KAJD,MAIO;AACL,YAAKC,kBAAL,GAA0B,IAAIL,aAAaM,UAAjB,CAA4B;AACpDC,eAAO,oBAD6C;AAEpDC,cAAM,IAF8C;AAGpDC,gBAAQ;AAH4C,OAA5B,CAA1B;AAKD;;AAED,QAAI,MAAKN,MAAL,CAAYO,MAAhB,EAAwB;AACtB,YAAKC,aAAL,GAAqB,IAAIX,aAAaM,UAAjB,CACnB,MAAKH,MAAL,CAAYO,MADO,CAArB;AAGD,KAJD,MAIO;AACL,YAAKC,aAAL,GAAqB,IAAIX,aAAaM,UAAjB,CAA4B;AAC/CC,eAAO,eADwC;AAE/CC,cAAM,IAFyC;AAG/CC,gBAAQ;AAHuC,OAA5B,CAArB;AAKD;;AAED,UAAKN,MAAL,CAAYS,IAAZ,GAAmB,MAAKT,MAAL,CAAYS,IAAZ,IAAoB,EAAvC;AACA,UAAKC,WAAL,GAAmB,MAAKV,MAAL,CAAYS,IAAZ,CAAiBE,GAAjB,CAAqBd,aAAaM,UAAlC,CAAnB;AACA,UAAKS,cAAL;;AAEA,UAAKC,SAAL,GAAiB,EAAjB;AACA,UAAKb,MAAL,CAAYa,SAAZ,GAAwB,MAAKb,MAAL,CAAYa,SAAZ,IAAyB,EAAjD;AACA,UAAKA,SAAL,GAAiB,iBAAEF,GAAF,CAAM,MAAKX,MAAL,CAAYa,SAAlB,EAA6B,gBAAQ;AACpD,UAAIC,IAAI,gBAAMC,kBAAN,CAAyBC,KAAKC,OAA9B,EAAuC,EAACC,mBAAmB,KAApB,EAAvC,CAAR;AACAJ,QAAEK,MAAF,GAAWH,KAAKG,MAAL,CAAYC,KAAZ,EAAX;AACA,aAAON,CAAP;AACD,KAJgB,CAAjB;;AAMA,QAAI,MAAKd,MAAL,CAAYqB,EAAhB,EAAoB;AAClB,YAAKC,SAAL,GAAiBzB,aAAaM,UAAb,CAAwB,MAAKH,MAAL,CAAYqB,EAApC,CAAjB;AACD,KAFD,MAEO;AACL,YAAKC,SAAL,GAAiBzB,aAAaM,UAAb,CAAwB;AACvCC,eAAO,WADgC;AAEvCC,cAAM,IAFiC;AAGvCC,gBAAQ;AAH+B,OAAxB,CAAjB;AAKD;;AAnD4D;AAqD9D;;;;uCAEkB;AACjB,WAAKN,MAAL,CAAYuB,QAAZ,GAAuB,CAAC,KAAKvB,MAAL,CAAYuB,QAApC;AACD;;;iCAEY;AACX,aAAO,KAAKC,UAAL,CAAgBC,eAAhB,GACNC,IADM,CACD,KAAKC,mBAAL,CAAyB,IAAzB,CADC,CAAP;AAED;;;sCAEiB;AAChB,aAAO,KAAK/B,EAAL,CAAQgC,IAAR,CAAa,CAClB,EAACC,MAAM,QAAP,EAAiBzB,OAAO,KAAxB,EADkB,EAElB,EAACyB,MAAM,QAAP,EAAiBzB,OAAO,KAAxB,EAFkB,EAGlB,EAACyB,MAAM,QAAP,EAAiBzB,OAAO,KAAxB,EAHkB,EAIlB,EAACyB,MAAM,QAAP,EAAiBzB,OAAO,KAAxB,EAJkB,CAAb,CAAP;AAMD;;;4BAEO;AACN,aAAO,KAAKR,EAAL,CAAQgC,IAAR,CAAa,CAClB,EAACC,MAAM,MAAP,EAAezB,OAAO,MAAtB,EADkB,EAElB,EAACyB,MAAM,UAAP,EAAmBzB,OAAO,UAA1B,EAFkB,EAGlB,EAACyB,MAAM,SAAP,EAAkBzB,OAAO,SAAzB,EAHkB,CAAb,CAAP;AAKD;;;4BAEO0B,O,EAAS;AAAA;;AACf,aAAO,KAAKN,UAAL,CAAgBO,cAAhB,GACNL,IADM,CACD,KAAKC,mBAAL,CAAyB,KAAzB,CADC,EAEND,IAFM,CAED,mBAAW;AACf,YAAII,QAAQE,IAAR,KAAiB,aAArB,EAAoC;AAClC,cAAIC,gBAAgB,OAAKpC,YAAL,CAAkBM,UAAlB,CAA6B,EAAC0B,MAAM,OAAK9B,UAAZ,EAAwBK,OAAO,OAAKL,UAApC,EAA7B,CAApB;AACAmC,kBAAQC,OAAR,CAAgBF,aAAhB;AACD;;AAED,eAAOC,OAAP;AACD,OATM,CAAP;AAUD;;;yCAEoB;AACnB,WAAKlC,MAAL,CAAYC,WAAZ,GAA0B,KAAKC,kBAAL,CAAwBE,KAAlD;AACA,WAAKgC,SAAL,CAAeC,OAAf;AACD;;;oCAEe;AACd,WAAKrC,MAAL,CAAYO,MAAZ,GAAqB,KAAKC,aAAL,CAAmBJ,KAAxC;AACA,WAAKgC,SAAL,CAAeC,OAAf;AACD;;;gCAEW;AACV,UAAI,KAAKf,SAAL,CAAelB,KAAf,KAAyB,MAA7B,EAAqC;AACnC,aAAKJ,MAAL,CAAYqB,EAAZ,GAAiB,IAAjB;AACD,OAFD,MAEO;AACL,aAAKrB,MAAL,CAAYqB,EAAZ,GAAiB,KAAKC,SAAL,CAAelB,KAAhC;AACD;AACD,WAAKgC,SAAL,CAAeC,OAAf;AACD;;;qCAEgB;AACf,UAAIC,QAAQ,KAAK5B,WAAL,CAAiB6B,MAA7B;AACA,UAAIC,cAAc,KAAK9B,WAAL,CAAiB+B,KAAKC,GAAL,CAASJ,QAAM,CAAf,EAAkB,CAAlB,CAAjB,CAAlB;;AAEA,UAAI,CAACE,WAAD,IAAgBA,YAAYR,IAAZ,KAAqB,aAAzC,EAAwD;AACtD,aAAKtB,WAAL,CAAiBiC,IAAjB,CAAsB,KAAK9C,YAAL,CAAkB+C,aAAlB,EAAtB;AACD;AACF;;;oCAEe;AACd,UAAI,KAAKC,KAAT,EAAgB;AACd;AACD;;AAED,WAAKT,SAAL,CAAeC,OAAf;AACD;;;uCAEmB;AAClB,WAAKrC,MAAL,CAAYa,SAAZ,GAAwB,iBAAEF,GAAF,CAAM,KAAKE,SAAX,EAAsB,gBAAQ;AACpD,eAAO;AACLI,mBAASD,KAAK8B,GAAL,CAASC,IADb;AAEL5B,kBAAQH,KAAKG,MAAL,CAAYC,KAAZ;AAFH,SAAP;AAID,OALuB,CAAxB;AAMD;;;mCAEcJ,I,EAAM;AACnB,WAAKH,SAAL,GAAiB,iBAAEmC,OAAF,CAAU,KAAKnC,SAAf,EAA0BG,IAA1B,CAAjB;AACA,WAAKiC,gBAAL;AACA,WAAKC,aAAL;AACD;;;gCAEWjC,O,EAAS;AACnB,UAAID,OAAO,gBAAMD,kBAAN,CAAyBE,OAAzB,EAAkC,EAACC,mBAAmB,IAApB,EAAlC,CAAX;AACAF,WAAKmC,KAAL,GAAa,IAAb;AACA,WAAKtC,SAAL,CAAe8B,IAAf,CAAoB3B,IAApB;AACA,WAAKiC,gBAAL;AACA,WAAKC,aAAL;AACD;;;sCAEiBpB,O,EAASsB,K,EAAO;AAChC,UAAItB,QAAQ1B,KAAR,KAAkB,KAAKL,UAA3B,EAAuC;AACrC,aAAKW,WAAL,CAAiB2C,MAAjB,CAAwBD,KAAxB,EAA+B,CAA/B;AACD;;AAED,UAAIE,eAAe,iBAAEC,MAAF,CAAS,KAAK7C,WAAd,EAA2B;AAAA,eAAWoB,QAAQ1B,KAAnB;AAAA,OAA3B,CAAnB;AACA,WAAKJ,MAAL,CAAYS,IAAZ,GAAmB6C,aAAa3C,GAAb,CAAiB;AAAA,eAAWmB,QAAQ1B,KAAnB;AAAA,OAAjB,CAAnB;;AAEA,WAAKM,WAAL,GAAmB,iBAAEC,GAAF,CAAM,KAAKX,MAAL,CAAYS,IAAlB,EAAwB,KAAKZ,YAAL,CAAkBM,UAA1C,CAAnB;AACA,WAAKS,cAAL;;AAEA,WAAKwB,SAAL,CAAeC,OAAf;AACD;;;wCAEmBmB,e,EAAiB;AAAA;;AACnC,aAAO,UAACtB,OAAD,EAAa;AAClB,YAAIuB,WAAW,iBAAE9C,GAAF,CAAMuB,OAAN,EAAe,mBAAW;AACvC,cAAI/B,aAAa,EAAEC,OAAO0B,QAAQD,IAAjB,EAAuB6B,YAAY5B,QAAQ4B,UAA3C,EAAjB;AACA,iBAAO,OAAK7D,YAAL,CAAkBM,UAAlB,CAA6BA,UAA7B,CAAP;AACD,SAHc,CAAf;;AAKA,YAAIqD,eAAJ,EAAqB;AAAA;AAAA;AAAA;;AAAA;AACnB,iCAAqB,OAAK1D,WAAL,CAAiB6D,SAAtC,8HAAiD;AAAA,kBAAxCC,QAAwC;;AAC/C,kBAAIzD,aAAa,EAAE6B,MAAM,UAAR,EAAoB5B,OAAO,MAAMwD,SAASb,IAA1C,EAAgDW,YAAY,IAA5D,EAAjB;AACAD,uBAAStB,OAAT,CAAiB,OAAKtC,YAAL,CAAkBM,UAAlB,CAA6BA,UAA7B,CAAjB;AACD;AAJkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKpB;;AAED,eAAOsD,QAAP;AACD,OAdD;AAeD;;;uCAEkB;AACjB,UAAI,KAAKzD,MAAL,CAAYuB,QAAhB,EAA0B;AACxB,eAAO,KAAKvB,MAAL,CAAY6D,KAAnB;AACD,OAFD,MAEO;AACL,eAAOrE,aAAasE,UAAb,CAAwB,KAAK9D,MAA7B,CAAP;AACD;AACF;;;;;;AAGHP,iBAAiBsE,WAAjB,GAA+B,4BAA/B","file":"query_ctrl.js","sourcesContent":["import _ from 'lodash';\nimport dfunc from './dfunc';\nimport {QueryCtrl} from 'app/plugins/sdk';\nimport './func_editor';\nimport './add_datadog_func';\nimport * as queryBuilder from './query_builder';\n\nexport class DataDogQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, $q, uiSegmentSrv, templateSrv)  {\n    super($scope, $injector);\n    this.removeText = '-- remove tag --';\n    this.$q = $q;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.templateSrv = templateSrv;\n\n    if (this.target.aggregation) {\n      this.aggregationSegment = new uiSegmentSrv.newSegment(\n        this.target.aggregation\n      );\n    } else {\n      this.aggregationSegment = new uiSegmentSrv.newSegment({\n        value: 'Select Aggregation',\n        fake: true,\n        custom: false,\n      });\n    }\n\n    if (this.target.metric) {\n      this.metricSegment = new uiSegmentSrv.newSegment(\n        this.target.metric\n      );\n    } else {\n      this.metricSegment = new uiSegmentSrv.newSegment({\n        value: 'Select Metric',\n        fake: true,\n        custom: false,\n      });\n    }\n\n    this.target.tags = this.target.tags || [];\n    this.tagSegments = this.target.tags.map(uiSegmentSrv.newSegment);\n    this.fixTagSegments();\n\n    this.functions = [];\n    this.target.functions = this.target.functions || [];\n    this.functions = _.map(this.target.functions, func => {\n      var f = dfunc.createFuncInstance(func.funcDef, {withDefaultParams: false});\n      f.params = func.params.slice();\n      return f;\n    });\n\n    if (this.target.as) {\n      this.asSegment = uiSegmentSrv.newSegment(this.target.as);\n    } else {\n      this.asSegment = uiSegmentSrv.newSegment({\n        value: 'Select As',\n        fake: true,\n        custom: false,\n      });\n    }\n\n  }\n\n  toggleEditorMode() {\n    this.target.rawQuery = !this.target.rawQuery;\n  }\n\n  getMetrics() {\n    return this.datasource.metricFindQuery()\n    .then(this.transformToSegments(true));\n  }\n\n  getAggregations() {\n    return this.$q.when([\n      {text: 'avg by', value: 'avg'},\n      {text: 'max by', value: 'max'},\n      {text: 'min by', value: 'min'},\n      {text: 'sub by', value: 'sum'},\n    ]);\n  }\n\n  getAs() {\n    return this.$q.when([\n      {text: 'None', value: 'None'},\n      {text: 'as_count', value: 'as_count'},\n      {text: 'as_rate', value: 'as_rate'},\n    ]);\n  }\n\n  getTags(segment) {\n    return this.datasource.metricFindTags()\n    .then(this.transformToSegments(false))\n    .then(results => {\n      if (segment.type !== 'plus-button') {\n        let removeSegment = this.uiSegmentSrv.newSegment({text: this.removeText, value: this.removeText});\n        results.unshift(removeSegment);\n      }\n\n      return results;\n    });\n  }\n\n  aggregationChanged() {\n    this.target.aggregation = this.aggregationSegment.value;\n    this.panelCtrl.refresh();\n  }\n\n  metricChanged() {\n    this.target.metric = this.metricSegment.value;\n    this.panelCtrl.refresh();\n  }\n\n  asChanged() {\n    if (this.asSegment.value === 'None') {\n      this.target.as = null;\n    } else {\n      this.target.as = this.asSegment.value;\n    }\n    this.panelCtrl.refresh();\n  }\n\n  fixTagSegments() {\n    var count = this.tagSegments.length;\n    var lastSegment = this.tagSegments[Math.max(count-1, 0)];\n\n    if (!lastSegment || lastSegment.type !== 'plus-button') {\n      this.tagSegments.push(this.uiSegmentSrv.newPlusButton());\n    }\n  }\n\n  targetChanged() {\n    if (this.error) {\n      return;\n    }\n\n    this.panelCtrl.refresh();\n  }\n\n  persistFunctions () {\n    this.target.functions = _.map(this.functions, func => {\n      return {\n        funcDef: func.def.name,\n        params: func.params.slice(),\n      };\n    });\n  }\n\n  removeFunction(func) {\n    this.functions = _.without(this.functions, func);\n    this.persistFunctions();\n    this.targetChanged();\n  }\n\n  addFunction(funcDef) {\n    var func = dfunc.createFuncInstance(funcDef, {withDefaultParams: true});\n    func.added = true;\n    this.functions.push(func);\n    this.persistFunctions();\n    this.targetChanged();\n  }\n\n  tagSegmentUpdated(segment, index) {\n    if (segment.value === this.removeText) {\n      this.tagSegments.splice(index, 1);\n    }\n\n    let realSegments = _.filter(this.tagSegments, segment => segment.value);\n    this.target.tags = realSegments.map(segment => segment.value);\n\n    this.tagSegments = _.map(this.target.tags, this.uiSegmentSrv.newSegment);\n    this.fixTagSegments();\n\n    this.panelCtrl.refresh();\n  }\n\n  transformToSegments(addTemplateVars) {\n    return (results) => {\n      var segments = _.map(results, segment => {\n        let newSegment = { value: segment.text, expandable: segment.expandable };\n        return this.uiSegmentSrv.newSegment(newSegment);\n      });\n\n      if (addTemplateVars) {\n        for (let variable of this.templateSrv.variables) {\n          let newSegment = { type: 'template', value: '$' + variable.name, expandable: true };\n          segments.unshift(this.uiSegmentSrv.newSegment(newSegment));\n        }\n      }\n\n      return segments;\n    };\n  }\n\n  getCollapsedText() {\n    if (this.target.rawQuery) {\n      return this.target.query;\n    } else {\n      return queryBuilder.buildQuery(this.target);\n    }\n  }\n}\n\nDataDogQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}