{"version":3,"sources":["../src/query_builder.js"],"names":["buildQuery","target","adhocFilters","aggregation","metric","tags","functions","query","functionInstances","getFunctionInstances","length","join","adhocTags","buildAdHocFilterString","as","groupedFuncs","_","groupBy","func","def","append","each","appends","render","wraps","map","f","dfunc","createFuncInstance","funcDef","withDefaultParams","params","slice","filter","key","value"],"mappings":";;;;;;;AAGO,UAASA,UAAT,CAAoBC,MAApB,EAA4BC,YAA5B,EAA0C;AAAA,MAC3CC,WAD2C,GACHF,MADG,CAC3CE,WAD2C;AAAA,MAC9BC,MAD8B,GACHH,MADG,CAC9BG,MAD8B;AAAA,MACtBC,IADsB,GACHJ,MADG,CACtBI,IADsB;AAAA,MAChBC,SADgB,GACHL,MADG,CAChBK,SADgB;;AAEhD,MAAIC,QAAWJ,WAAX,SAA0BC,MAA9B;;AAEA,MAAII,oBAAqBC,qBAAqBH,SAArB,CAAzB;;AAEA,MAAKD,QAAQA,KAAKK,MAAd,IAA0BR,gBAAgBA,aAAaQ,MAA3D,EAAoE;AAClEH,YAAS,GAAT;;AAEA,OAAIF,QAAQA,KAAKK,MAAjB,EAAyB;AACxBH,aAASF,KAAKM,IAAL,CAAU,GAAV,CAAT;AACA;;AAED,OAAIT,gBAAgBA,aAAaQ,MAAjC,EAAyC;AACxC,QAAIE,YAAYC,uBAAuBX,YAAvB,CAAhB;AACA,QAAIG,QAAQA,KAAKK,MAAjB,EAAyB;AACxBH,cAAS,GAAT;AACA;AACDA,aAASK,SAAT;AACA;;AAEDL,YAAS,GAAT;AACD,GAhBD,MAgBO;AACLA,YAAS,KAAT;AACD;;AAED,MAAIN,OAAOa,EAAX,EAAe;AACbP,YAAS,MAAMN,OAAOa,EAAb,GAAkB,IAA3B;AACD;;AAED,MAAIC,eAAeC,EAAEC,OAAF,CAAUT,iBAAV,EAA6B,gBAAQ;AACtD,OAAIU,KAAKC,GAAL,CAASC,MAAb,EAAqB;AACnB,WAAO,SAAP;AACD,IAFD,MAEO;AACL,WAAO,OAAP;AACD;AACF,GANkB,CAAnB;;AAQAJ,IAAEK,IAAF,CAAON,aAAaO,OAApB,EAA6B,gBAAQ;AACnCf,YAAS,MAAOW,KAAKK,MAAL,EAAhB;AACD,GAFD;;AAIAP,IAAEK,IAAF,CAAON,aAAaS,KAApB,EAA2B,gBAAQ;AACjCjB,WAAQW,KAAKK,MAAL,CAAYhB,KAAZ,CAAR;AACD,GAFD;;AAIA,SAAOA,KAAP;AACA;;uBA/CeP,U;;AAiDhB,UAASS,oBAAT,CAA8BH,SAA9B,EAAyC;AACxC,SAAOU,EAAES,GAAF,CAAMnB,SAAN,EAAiB,gBAAQ;AAC9B,OAAIoB,IAAIC,MAAMC,kBAAN,CAAyBV,KAAKW,OAA9B,EAAuC,EAACC,mBAAmB,KAApB,EAAvC,CAAR;AACAJ,KAAEK,MAAF,GAAWb,KAAKa,MAAL,CAAYC,KAAZ,EAAX;AACA,UAAON,CAAP;AACD,GAJM,CAAP;AAKA;;AAED,UAASb,sBAAT,CAAgCX,YAAhC,EAA8C;AAC5C,SAAOA,aAAauB,GAAb,CAAiB,kBAAU;AAChC,UAAOQ,OAAOC,GAAP,GAAa,GAAb,GAAmBD,OAAOE,KAAjC;AACD,GAFM,EAEJxB,IAFI,CAEC,GAFD,CAAP;AAGD;;;AAhEMK,I;;AACAW,Q","file":"query_builder.js","sourcesContent":["import _ from 'lodash';\nimport dfunc from './dfunc';\n\nexport function buildQuery(target, adhocFilters) {\n\tlet {aggregation, metric, tags, functions} = target;\n\tlet query = `${aggregation}:${metric}`;\n\n\tlet functionInstances  = getFunctionInstances(functions);\n\n\tif ((tags && tags.length) || (adhocFilters && adhocFilters.length)) {\n\t  query += '{';\n\n\t  if (tags && tags.length) {\n\t  \tquery += tags.join(',');\n\t  }\n\n\t  if (adhocFilters && adhocFilters.length) {\n\t  \tlet adhocTags = buildAdHocFilterString(adhocFilters);\n\t  \tif (tags && tags.length) {\n\t  \t\tquery += ',';\n\t  \t}\n\t  \tquery += adhocTags;\n\t  }\n\n\t  query += '}';\n\t} else {\n\t  query += '{*}';\n\t}\n\n\tif (target.as) {\n\t  query += '.' + target.as + '()';\n\t}\n\n\tvar groupedFuncs = _.groupBy(functionInstances, func => {\n\t  if (func.def.append) {\n\t    return 'appends';\n\t  } else {\n\t    return 'wraps';\n\t  }\n\t});\n\n\t_.each(groupedFuncs.appends, func => {\n\t  query += '.'  + func.render();\n\t});\n\n\t_.each(groupedFuncs.wraps, func => {\n\t  query = func.render(query);\n\t});\n\n\treturn query;\n}\n\nfunction getFunctionInstances(functions) {\n\treturn _.map(functions, func => {\n\t  var f = dfunc.createFuncInstance(func.funcDef, {withDefaultParams: false});\n\t  f.params = func.params.slice();\n\t  return f;\n\t});\n}\n\nfunction buildAdHocFilterString(adhocFilters) {\n  return adhocFilters.map(filter => {\n    return filter.key + ':' + filter.value;\n  }).join(',');\n}\n"]}